<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>CraftNet Ultimate - Media Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
<style>
:root{--bg:#1e1e1e;--panel:#333;--green:#5da03b;--dirt:#866043;--admin:#b04bff;--blue:#3498db;--red:#e74c3c;--gold:#ffcc00;}
body{margin:0;background:var(--bg);color:white;font-family:'VT323',monospace;overflow-x:hidden;}
.hidden{display:none!important;}
header{background:var(--dirt);border-bottom:4px solid #000;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;z-index:100;position:sticky;top:0;}
.header-title{cursor:pointer;color:#3f3;font-family:'Press Start 2P';font-size:0.8rem;}
.avatar{width:40px;height:40px;border:2px solid #000;image-rendering:pixelated;object-fit:cover;}
.container{max-width:700px;margin:20px auto;padding:0 10px}

/* SIDE MENU */
#side-menu{position:fixed;top:60px;left:0;width:280px;height:calc(100% - 60px);background:#222;border-right:4px solid #000;z-index:90;padding:20px;box-sizing:border-box;transform:translateX(-100%);transition:0.3s;}
#side-menu.open{transform:translateX(0);}
.menu-item{background:#444;border:2px solid #000;padding:10px;margin-bottom:10px;cursor:pointer;font-family:'Press Start 2P';font-size:0.5rem;text-align:center;color:white;text-decoration:none;display:block;}
.menu-item:hover{background:var(--green);}

/* CHAT WINDOW */
.chat-window{position:fixed;bottom:0;right:20px;width:320px;height:450px;background:#222;border:3px solid #000;display:flex;flex-direction:column;z-index:2000;box-shadow: 0 0 20px rgba(0,0,0,0.5);}
.chat-header{background:var(--green);padding:10px;display:flex;justify-content:space-between;font-family:'Press Start 2P';font-size:0.5rem;align-items:center;border-bottom:2px solid #000;}
.chat-messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:#111;}
.msg{padding:8px 12px;border-radius:4px;max-width:85%;font-size:1.2rem;word-wrap:break-word;border:1px solid rgba(255,255,255,0.1);}
.msg.me{background:var(--green);align-self:flex-end;color:white;}
.msg.them{background:#333;align-self:flex-start;color:#3f3;}

/* POSTS */
.post{background:var(--panel);border:3px solid #000;margin-bottom:20px}
.post-header{background:#444;padding:10px;display:flex;gap:10px;align-items:center}
.post-body{padding:15px;font-size:1.5rem;word-wrap:break-word;}
.post-footer{background:#222;padding:10px;display:flex;gap:20px;font-size:1.2rem;border-top:1px solid #444;align-items:center;}
.like-btn{cursor:pointer;}
.liked{color: var(--red);}

/* UI / MODAL */
input,textarea{width:100%;box-sizing:border-box;padding:8px;margin:6px 0;background:#000;color:#3f3;border:2px solid #555;font-family:'VT323';font-size:1.2rem;}
.btn{padding:10px;margin-top:8px;border:2px solid #000;cursor:pointer;background:#aaa;font-family:'Press Start 2P';font-size:.5rem}
.btn-green{background:var(--green);color:white}
.btn-red{background:var(--red);color:white}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:1000}
.card{background:#8b8b8b;border:4px solid #000;padding:20px;width:90%;max-width:400px;text-align:center;}
.comment-box{max-height:200px; overflow-y:auto; text-align:left; background:#111; padding:10px; border:2px solid #000; margin:10px 0;}
</style>
</head>
<body>

<div id="auth-modal" class="modal">
    <div class="card">
        <h2 id="auth-title">LOGIN</h2>
        <input id="auth-user" placeholder="Name">
        <input id="auth-pass" type="password" placeholder="Passwort">
        <input id="auth-skin" class="hidden" placeholder="Skin-URL">
        <button class="btn btn-green" id="auth-btn" style="width:100%">WELT BETRETEN</button>
        <p id="toggle-auth" style="cursor:pointer;font-size:.8rem;margin-top:10px">Registrieren</p>
    </div>
</div>

<header>
    <div class="header-title" id="menu-trigger">‚ò∞ CRAFTNET</div>
    <div id="nav-info" class="hidden" style="display:flex;gap:10px;align-items:center">
        <img id="nav-avatar" class="avatar">
        <button class="btn btn-red" id="btn-logout" style="margin:0; padding:5px 10px;">X</button>
    </div>
</header>

<div id="side-menu">
    <div class="menu-item" onclick="location.reload()">üè† HOME</div>
    <a href="projekt.html" class="menu-item" style="background:var(--gold); color:black; text-decoration:none;">üéÆ PROJEKT-INFO</a>
    <div class="menu-item" onclick="window.openProfileEdit()">‚öôÔ∏è PROFIL</div>
    <div class="menu-item" onclick="window.openFriendsList()">ü§ù FREUNDE</div>
    <div id="admin-section" class="hidden">
        <hr style="border:1px solid #000">
        <div class="menu-item" style="background:var(--admin)" onclick="window.openAdminPanel()">üëë USER CONTROL</div>
    </div>
</div>

<div id="main" class="container hidden">
    <div class="post" style="padding:15px;background:#444">
        <textarea id="post-text" placeholder="Was gibt's Neues?"></textarea>
        <input id="post-media" placeholder="YouTube oder Bild-URL">
        <button class="btn btn-green" id="btn-post" style="width:100%">POSTEN</button>
    </div>
    <div id="feed">Lade Welt...</div>
</div>

<div id="chat-container"></div>

<div id="ui-modal" class="modal hidden">
    <div class="card" id="ui-content"></div>
    <button onclick="window.closeUI()" class="btn btn-red" style="position:fixed; bottom:20px;">SCHLIESSEN</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, orderBy, updateDoc, arrayUnion, arrayRemove, deleteDoc, addDoc, limit, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDxV7vSYCg5MwgakrdEsgWcQF6ZlEyDWkg",
  authDomain: "craftnet-1c6d1.firebaseapp.com",
  projectId: "craftnet-1c6d1",
  storageBucket: "craftnet-1c6d1.firebasestorage.app",
  messagingSenderId: "679779814784",
  appId: "1:679779814784:web:d42642d13217015f9f8565"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMINS = ["Mauvi_"]; 
let currentUser = null;
let allUsers = {};
let currentChatUnsubscribe = null;
const el = id => document.getElementById(id);

el("menu-trigger").onclick = () => el("side-menu").classList.toggle("open");

/* --- LOGIN / REGISTER --- */
el("toggle-auth").onclick = () => {
    const isLogin = el("auth-title").innerText === "LOGIN";
    el("auth-title").innerText = isLogin ? "REGISTRIEREN" : "LOGIN";
    el("auth-skin").classList.toggle("hidden", !isLogin);
};

async function login(name, data) {
    currentUser = name;
    localStorage.setItem("craftnet_session", name);
    el("auth-modal").classList.add("hidden");
    el("main").classList.remove("hidden");
    el("nav-info").classList.remove("hidden");
    el("nav-avatar").src = data.skin || `https://minotar.net/avatar/${name}`;
    if(ADMINS.includes(name)) el("admin-section").classList.remove("hidden");
    startApp();
}

el("auth-btn").onclick = async () => {
    const n = el("auth-user").value.trim();
    const p = el("auth-pass").value;
    if(!n || p.length < 4) return alert("Eingabe pr√ºfen!");
    const snap = await getDoc(doc(db, "users", n));
    if(el("auth-title").innerText === "LOGIN") {
        if(snap.exists() && snap.data().pass === p) login(n, snap.data());
        else alert("Falsche Daten!");
    } else {
        if(snap.exists()) return alert("Name vergeben!");
        const data = { pass: p, skin: el("auth-skin").value || `https://minotar.net/avatar/${n}`, bio: "Miner", friends: [] };
        await setDoc(doc(db, "users", n), data);
        login(n, data);
    }
};

el("btn-logout").onclick = () => { localStorage.removeItem("craftnet_session"); location.reload(); };

window.addEventListener('DOMContentLoaded', async () => {
    const saved = localStorage.getItem("craftnet_session");
    if(saved) {
        const snap = await getDoc(doc(db, "users", saved));
        if(snap.exists()) login(saved, snap.data());
    }
});

/* --- FEED & KOMMENTARE --- */
function startApp() {
    onSnapshot(collection(db, "users"), snap => snap.forEach(d => allUsers[d.id] = d.data()));
    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(30));
    onSnapshot(q, snap => {
        el("feed").innerHTML = "";
        snap.forEach(docSnap => {
            const p = docSnap.data();
            const id = docSnap.id;
            const hasLiked = p.likedBy?.includes(currentUser);
            const ytId = p.media?.match(/(?:v=|\.be\/|embed\/)([^&?#/]+)/)?.[1];
            
            el("feed").innerHTML += `
                <div class="post">
                    <div class="post-header">
                        <img class="avatar" src="${allUsers[p.author]?.skin || ''}">
                        <b onclick="window.showUserPage('${p.author}')" style="cursor:pointer">${p.author}</b>
                    </div>
                    <div class="post-body">
                        ${p.text}
                        ${ytId ? `<iframe src="https://www.youtube.com/embed/${ytId}" frameborder="0" style="width:100%; height:300px"></iframe>` : ""}
                        ${(p.media && !ytId) ? `<img src="${p.media}" style="width:100%;margin-top:10px;border:2px solid #000">` : ""}
                    </div>
                    <div class="post-footer">
                        <span class="like-btn ${hasLiked ? 'liked' : ''}" onclick="window.toggleLike('${id}', ${hasLiked})">
                            ${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${p.likes || 0}
                        </span>
                        <span onclick="window.showComments('${id}')" style="cursor:pointer">üí¨ ${p.comments?.length || 0}</span>
                        ${ADMINS.includes(currentUser) ? `<span onclick="window.delPost('${id}')" style="color:red;cursor:pointer">üóë</span>` : ""}
                    </div>
                </div>`;
        });
    });
}

/* --- KOMMENTAR-FUNKTION --- */
window.showComments = async (postId) => {
    const postSnap = await getDoc(doc(db, "posts", postId));
    const p = postSnap.data();
    el("ui-modal").classList.remove("hidden");
    
    let commHtml = `<h3>KOMMENTARE</h3><div class="comment-box" id="modal-comm-list">`;
    if(p.comments && p.comments.length > 0) {
        p.comments.forEach(c => {
            commHtml += `<div style="margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:4px;">
                <b style="color:var(--green)">${c.u}:</b> ${c.t}
            </div>`;
        });
    } else {
        commHtml += `<p style="opacity:0.5; font-size:1rem;">Keine Kommentare vorhanden.</p>`;
    }
    commHtml += `</div>`;
    commHtml += `<input id="new-comm-input" placeholder="Schreibe etwas...">`;
    commHtml += `<button class="btn btn-green" style="width:100%" onclick="window.submitComment('${postId}')">SENDEN</button>`;
    
    el("ui-content").innerHTML = commHtml;
};

window.submitComment = async (id) => {
    const input = el("new-comm-input");
    const text = input.value.trim();
    if(!text) return;
    await updateDoc(doc(db, "posts", id), { 
        comments: arrayUnion({ u: currentUser, t: text }) 
    });
    window.showComments(id); // Liste neu laden
};

/* --- LIKE-FUNKTION --- */
window.toggleLike = async (postId, alreadyLiked) => {
    const postRef = doc(db, "posts", postId);
    await updateDoc(postRef, {
        likes: increment(alreadyLiked ? -1 : 1),
        likedBy: alreadyLiked ? arrayRemove(currentUser) : arrayUnion(currentUser)
    });
};

el("btn-post").onclick = async () => {
    const text = el("post-text").value.trim();
    if(!text) return;
    await addDoc(collection(db, "posts"), { 
        author: currentUser, text, media: el("post-media").value, 
        timestamp: Date.now(), comments: [], likes: 0, likedBy: [] 
    });
    el("post-text").value = ""; el("post-media").value = "";
};

window.delPost = async id => { if(confirm("L√∂schen?")) await deleteDoc(doc(db, "posts", id)); };

/* --- CHAT SYSTEM --- */
window.openChat = (target) => {
    window.closeUI(); el("side-menu").classList.remove("open");
    if(currentChatUnsubscribe) currentChatUnsubscribe();
    const chatId = [currentUser, target].sort().join("_");
    el("chat-container").innerHTML = `<div class="chat-window"><div class="chat-header"><span>${target}</span><span onclick="this.parentElement.parentElement.remove()" style="cursor:pointer">X</span></div><div id="chat-msgs" class="chat-messages"></div><div style="padding:10px; background:#222;"><input id="chat-input" placeholder="Nachricht..."></div></div>`;
    const q = query(collection(db, "chats", chatId, "messages"), orderBy("t", "asc"), limit(100));
    currentChatUnsubscribe = onSnapshot(q, snap => {
        const box = el("chat-msgs"); box.innerHTML = "";
        snap.forEach(d => {
            const m = d.data();
            box.innerHTML += `<div class="msg ${m.u === currentUser ? 'me' : 'them'}">${m.m}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });
    el("chat-input").onkeydown = async e => {
        if(e.key === "Enter" && e.target.value.trim()) {
            await addDoc(collection(db, "chats", chatId, "messages"), { u: currentUser, m: e.target.value, t: Date.now() });
            e.target.value = "";
        }
    };
};

/* --- UI HELPERS --- */
window.closeUI = () => el("ui-modal").classList.add("hidden");
window.openFriendsList = () => {
    const friends = allUsers[currentUser]?.friends || [];
    el("ui-modal").classList.remove("hidden");
    el("ui-content").innerHTML = `<h3>ü§ù FREUNDE</h3>` + (friends.length ? friends.map(f => `<button class="btn btn-green" style="width:100%; margin-bottom:5px" onclick="window.openChat('${f}')">${f} CHATTEN</button>`).join("") : "Noch keine Freunde.");
};
window.showUserPage = (name) => {
    const u = allUsers[name]; el("ui-modal").classList.remove("hidden");
    el("ui-content").innerHTML = `<img src="${u.skin}" style="width:80px; image-rendering:pixelated; border:2px solid #000"><h2>${name}</h2><p>${u.bio || 'Miner'}</p>${(name !== currentUser && !allUsers[currentUser].friends?.includes(name)) ? `<button class="btn btn-blue" onclick="window.addFriend('${name}')">HINZUF√úGEN</button>` : (name !== currentUser ? `<button class="btn btn-green" onclick="window.openChat('${name}')">CHAT</button>` : "")}`;
};
window.addFriend = async name => {
    await updateDoc(doc(db, "users", name), { friends: arrayUnion(currentUser) });
    await updateDoc(doc(db, "users", currentUser), { friends: arrayUnion(name) });
    alert("Befreundet!"); window.closeUI();
};
window.openProfileEdit = () => {
    const u = allUsers[currentUser]; el("ui-modal").classList.remove("hidden");
    el("ui-content").innerHTML = `<h3>‚öôÔ∏è PROFIL</h3>Skin URL:<input id="edit-skin" value="${u.skin || ''}">Bio:<textarea id="edit-bio">${u.bio || ''}</textarea><button class="btn btn-green" onclick="window.saveProfile()">SPEICHERN</button>`;
};
window.saveProfile = async () => {
    await updateDoc(doc(db, "users", currentUser), { skin: el("edit-skin").value, bio: el("edit-bio").value });
    location.reload();
};
window.openAdminPanel = async () => {
    el("ui-modal").classList.remove("hidden");
    const snap = await getDocs(collection(db, "users"));
    let html = "<h3>üëë ADMIN</h3>";
    snap.forEach(d => { if(d.id !== currentUser) html += `<div style="background:#444; margin:5px; padding:10px; border:2px solid #000"><b>${d.id}</b> <button class="btn btn-red" onclick="window.adminDelUser('${d.id}')">X</button></div>`; });
    el("ui-content").innerHTML = html;
};
window.adminDelUser = async n => { if(confirm(`L√∂schen?`)) await deleteDoc(doc(db, "users", n)); window.openAdminPanel(); };
</script>
</body>
</html>
