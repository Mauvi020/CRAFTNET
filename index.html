<script>
let isLoginMode = true;
let currentUser = null;

let accounts = JSON.parse(localStorage.getItem('cn_final_accounts')) || {};
let posts = JSON.parse(localStorage.getItem('cn_final_posts')) || [];

/* ================= AUTH ================= */

function toggleAuthMode() {
    isLoginMode = !isLoginMode;
    document.getElementById('auth-title').innerText = isLoginMode ? "LOGIN" : "REGISTRIEREN";
    document.getElementById('auth-skin').classList.toggle('hidden', isLoginMode);
    document.getElementById('toggle-auth').innerText =
        isLoginMode ? "Noch kein Account? Registrieren" : "Bereits ein Account? Login";
}

function showError(msg) {
    const err = document.getElementById('auth-error');
    err.innerText = msg;
    err.classList.remove('hidden');
}

function handleAuth() {
    const name = document.getElementById('auth-user').value.trim();
    const pass = document.getElementById('auth-pass').value;
    const skinVal = document.getElementById('auth-skin').value.trim();

    if (!name || pass.length < 4) return showError("Name & PW n√∂tig!");

    if (isLoginMode) {
        if (accounts[name] && accounts[name].pass === pass) login(name);
        else showError("Falsche Daten!");
    } else {
        if (accounts[name]) return showError("Name belegt!");

        let pfp = skinVal.includes('http')
            ? skinVal
            : `https://minotar.net/avatar/${skinVal || name}.png`;

        accounts[name] = { pass, skin: pfp };
        localStorage.setItem('cn_final_accounts', JSON.stringify(accounts));
        alert("Erfolgreich! Jetzt einloggen.");
        toggleAuthMode();
    }
}

function login(name) {
    currentUser = { name, ...accounts[name] };
    document.getElementById('auth-modal').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    document.getElementById('nav-info').classList.remove('hidden');
    document.getElementById('nav-name').innerText = name;
    document.getElementById('nav-avatar').src = currentUser.skin;
    renderFeed();
}

/* ================= POSTS ================= */

function extractYT(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]{11}).*/;
    const match = url.match(regExp);
    return match ? match[2] : null;
}

function createPost() {
    const text = document.getElementById('post-text').value;
    const video = document.getElementById('post-video').value;
    if (!text.trim()) return;

    posts.unshift({
        id: Date.now(),
        author: currentUser.name,
        pfp: currentUser.skin,
        text,
        video: extractYT(video),
        likes: [],
        comments: []
    });

    save();
    document.getElementById('post-text').value = "";
    document.getElementById('post-video').value = "";
    renderFeed();
}

/* ================= LIKES ================= */

function likePost(id) {
    const post = posts.find(p => p.id === id);
    if (!post || post.likes.includes(currentUser.name)) return;

    post.likes.push(currentUser.name);
    save();
    renderFeed();
}

/* ================= COMMENTS ================= */

function addComment(id) {
    const msg = prompt("Dein Kommentar:");
    if (!msg) return;

    const post = posts.find(p => p.id === id);
    post.comments.push({ user: currentUser.name, text: msg });
    save();
    renderFeed();
}

/* ================= RENDER ================= */

function save() {
    localStorage.setItem('cn_final_posts', JSON.stringify(posts));
}

function renderFeed() {
    const feed = document.getElementById('feed');
    feed.innerHTML = '';
    posts.forEach(p => renderSinglePost(p));
}

function renderSinglePost(p) {
    const feed = document.getElementById('feed');
    const liked = p.likes.includes(currentUser.name);

    let videoHtml = p.video
        ? `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${p.video}" frameborder="0" allowfullscreen></iframe></div>`
        : '';

    let commentsHtml = p.comments
        .map(c => `<div class="comment"><b>${c.user}:</b> ${c.text}</div>`)
        .join('');

    feed.innerHTML += `
        <div class="post">
            <div class="post-header">
                <img class="avatar" src="${p.pfp}">
                <b style="cursor:pointer;color:#5da03b"
                   onclick="showUserPosts('${p.author}')">${p.author}</b>
            </div>
            <div class="post-body">${p.text}</div>
            ${videoHtml}
            <div class="post-footer">
                <span onclick="likePost(${p.id})" style="cursor:pointer;${liked ? 'color:#3f3' : ''}">
                    ‚õèÔ∏è ${p.likes.length}
                </span>
                <span onclick="addComment(${p.id})" style="cursor:pointer">
                    üí¨ ${p.comments.length}
                </span>
            </div>
            <div class="comment-box ${p.comments.length === 0 ? 'hidden' : ''}">
                ${commentsHtml}
            </div>
        </div>
    `;
}

/* ================= PROFILE VIEW ================= */

function showUserPosts(username) {
    const feed = document.getElementById('feed');
    feed.innerHTML = `
        <div class="post" style="text-align:center">
            <b>Beitr√§ge von ${username}</b><br><br>
            <button class="btn" onclick="renderFeed()">‚¨Ö Zur√ºck</button>
        </div>
    `;

    posts
        .filter(p => p.author === username)
        .forEach(p => renderSinglePost(p));
}
</script>
